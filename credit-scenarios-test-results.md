# 订阅积分变化测试结果

## 测试总结

✅ **所有 12 个测试场景全部通过**

测试日期: 2025-11-16
测试脚本: `scripts/test-credit-scenarios.ts`

## 测试场景详情

### 1. Free -> Paid 场景（立即授予全额积分）

| 场景 | 旧计划 | 新计划 | 积分变化 | 行为 |
|------|--------|--------|----------|------|
| Free -> Pro (月付) | Free (0) | Pro 月付 (500) | +500 | ✅ 立即授予全额积分 |
| Free -> Pro (年付) | Free (0) | Pro 年付 (6000) | +6000 | ✅ 立即授予全额积分 |
| Free -> Pro+ (月付) | Free (0) | Pro+ 月付 (900) | +900 | ✅ 立即授予全额积分 |
| Free -> Pro+ (年付) | Free (0) | Pro+ 年付 (10800) | +10800 | ✅ 立即授予全额积分 |

### 2. 升级场景（立即授予积分差额）

| 场景 | 旧计划 | 新计划 | 积分变化 | 行为 |
|------|--------|--------|----------|------|
| Pro (月付) -> Pro+ (月付) | Pro 月付 (500) | Pro+ 月付 (900) | +400 | ✅ 立即授予积分差额 |
| Pro (月付) -> Pro (年付) | Pro 月付 (500) | Pro 年付 (6000) | +5500 | ✅ 立即授予积分差额 |
| Pro (月付) -> Pro+ (年付) | Pro 月付 (500) | Pro+ 年付 (10800) | +10300 | ✅ 立即授予积分差额 |

### 3. 降级场景（计划结束时生效）

| 场景 | 旧计划 | 新计划 | 积分变化 | 行为 |
|------|--------|--------|----------|------|
| Pro+ (月付) -> Pro (月付) | Pro+ 月付 (900) | Pro 月付 (500) | -400 → +500 | ⚠️ 计划结束时授予新计划全额积分 |
| Pro (年付) -> Pro (月付) | Pro 年付 (6000) | Pro 月付 (500) | -5500 → +500 | ⚠️ 计划结束时授予新计划全额积分 |
| Pro+ (年付) -> Pro (月付) | Pro+ 年付 (10800) | Pro 月付 (500) | -10300 → +500 | ⚠️ 计划结束时授予新计划全额积分 |

**降级行为说明**：
- 立即：不扣除积分，保持当前积分余额
- 计划结束时：授予新计划的全额积分（不是差额）

### 4. 续费场景（授予全额积分）

| 场景 | 旧计划 | 新计划 | 积分变化 | 行为 |
|------|--------|--------|----------|------|
| Pro (月付) 续费 | Pro 月付 (500) | Pro 月付 (500) | +500 | 🔄 授予全额积分（续费） |
| Pro+ (年付) 续费 | Pro+ 年付 (10800) | Pro+ 年付 (10800) | +10800 | 🔄 授予全额积分（续费） |

**续费行为说明**：
- 续费时授予全额积分，而不是差额（差额为 0）

## 积分计算规则

### 计划积分配置

| 计划 | 月付积分 | 年付积分 |
|------|----------|----------|
| Free | 0 | 0 |
| Pro | 500 | 6000 (500 × 12) |
| Pro+ | 900 | 10800 (900 × 12) |

### 积分变化规则

1. **新订阅（Free -> Paid）**：立即授予新计划的全额积分
2. **升级（积分增加）**：立即授予积分差额
3. **降级（积分减少）**：
   - 立即：不扣除积分，保持当前余额
   - 计划结束时：授予新计划的全额积分
4. **续费**：授予全额积分（不是差额）

## 实现逻辑

### 关键函数

- `resolvePlanByProductId()`: 将 Creem productId 解析为计划 ID
- `getCreditsForPlan()`: 根据计划 ID 和计费周期计算积分
- `grantSubscriptionCredits()`: 授予订阅积分（带幂等性检查）

### 代码位置

- 订阅创建/更新: `src/app/api/creem/sync-checkout/route.ts`
- Webhook 处理: `src/app/api/webhooks/creem/route.ts`
- 积分授予: `src/lib/creem/subscription-credits.ts`
- 计划解析: `src/lib/creem/plan-utils.ts`

## 测试覆盖

✅ Free -> Paid (4 个场景)
✅ 升级场景 (3 个场景)
✅ 降级场景 (3 个场景)
✅ 续费场景 (2 个场景)

**总计**: 12 个场景，全部通过 ✅

## 注意事项

1. **降级场景**：积分变化在当前计划结束时生效，而不是立即生效
2. **续费场景**：授予全额积分，确保用户获得完整的订阅权益
3. **幂等性**：所有积分授予操作都有幂等性检查，防止重复授予
4. **产品 ID 映射**：使用环境变量中的 `CREEM_*_PRODUCT_KEY_*` 来映射 productId 到计划 ID

## 运行测试

```bash
pnpm tsx scripts/test-credit-scenarios.ts
```

## 相关文档

- `subscription-credit-changes.md`: 详细的积分变化规则文档
- `check_credits_for_jefflee.sql`: 检查用户积分状态的 SQL 脚本
- `scripts/check-credits-for-jefflee.ts`: 检查用户积分状态的 TypeScript 脚本

