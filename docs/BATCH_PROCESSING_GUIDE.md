# æ‰¹é‡å¤„ç†ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†æ™ºèƒ½æ‰¹é‡è§†é¢‘/å›¾ç‰‡ç”Ÿæˆï¼Œé‡‡ç”¨**ä¼˜å…ˆé˜Ÿåˆ—æ¨¡å¼**ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹æ€§ï¼š

- âœ… **ç”¨æˆ·å‹å¥½é…ç½®**ï¼šç®€å•çš„å¹¶å‘æ•°å’Œæ‰¹æ¬¡å¤§å°
- âœ… **åº•å±‚æ™ºèƒ½ä¼˜åŒ–**ï¼šæ ¹æ®æ¨¡å‹ã€åˆ†è¾¨ç‡ã€æ—¶é•¿è‡ªåŠ¨è°ƒæ•´
- âœ… **ä¼˜å…ˆé˜Ÿåˆ—è°ƒåº¦**ï¼š720P å…ˆå¤„ç†ï¼Œç”¨æˆ·æ›´å¿«çœ‹åˆ°ç»“æœ
- âœ… **é”™è¯¯ Fallback**ï¼šè‡ªåŠ¨é‡è¯• + å¹¶å‘é™çº§æœºåˆ¶
- âœ… **è‡ªé€‚åº”è½®è¯¢**ï¼šæ ¹æ®å·²ç”¨æ—¶é—´åŠ¨æ€è°ƒæ•´æŸ¥è¯¢é—´éš”

---

## ğŸ¯ ç”¨æˆ·è§†è§’é…ç½®

### å¥—é¤å¹¶å‘é…ç½®

| å¥—é¤ | å¹¶å‘æ•° | æ‰¹æ¬¡å¤§å° | è¯´æ˜ |
|------|--------|---------|------|
| **Free** | 1ä¸ª | 3ä¸ª | æ¯æ‰¹3ä¸ªä»»åŠ¡ï¼Œå•ä¸ªå¤„ç† |
| **Pro** | 3ä¸ª | 15ä¸ª | æ¯æ‰¹15ä¸ªä»»åŠ¡ï¼Œæœ€å¤š3ä¸ªåŒæ—¶è¿›è¡Œ |
| **Pro+** | 5ä¸ª | 25ä¸ª | æ¯æ‰¹25ä¸ªä»»åŠ¡ï¼Œæœ€å¤š5ä¸ªåŒæ—¶è¿›è¡Œ |

### è§†é¢‘æ¨¡å‹ä¸å®šä»·

#### Sora 2ï¼ˆä»…æ”¯æŒ 720Pï¼‰

| æ—¶é•¿ | ç”Ÿæˆæ—¶é—´ | ç§¯åˆ†æ¶ˆè€— |
|------|---------|---------|
| 10ç§’ | 2-3åˆ†é’Ÿ | 15ç§¯åˆ† |
| 15ç§’ | 2-3åˆ†é’Ÿ | 20ç§¯åˆ† |

#### Sora 2 Proï¼ˆæ”¯æŒ 720P & 1080Pï¼Œæ›´é«˜è´¨é‡ï¼‰

| åˆ†è¾¨ç‡ | æ—¶é•¿ | ç”Ÿæˆæ—¶é—´ | ç§¯åˆ†æ¶ˆè€— |
|--------|------|---------|---------|
| 720P | 10ç§’ | 2-3åˆ†é’Ÿ | **45ç§¯åˆ†** (Sora 2 çš„ 3å€) |
| 720P | 15ç§’ | 2-3åˆ†é’Ÿ | **60ç§¯åˆ†** (Sora 2 çš„ 3å€) |
| 1080P | 10ç§’ | 7-13åˆ†é’Ÿ | **100ç§¯åˆ†** |
| 1080P | 15ç§’ | 7-13åˆ†é’Ÿ | **130ç§¯åˆ†** |

---

## ğŸ”§ åº•å±‚å®ç°åŸç†

### æ™ºèƒ½å¹¶å‘è°ƒæ•´

ç³»ç»Ÿä¼šæ ¹æ®ä»¥ä¸‹å› ç´ è‡ªåŠ¨è°ƒæ•´å®é™…å¹¶å‘æ•°ï¼š

```typescript
å®é™…å¹¶å‘ = åŸºç¡€å¹¶å‘ Ã— åˆ†è¾¨ç‡æƒé‡ Ã— æ—¶é•¿æƒé‡

åˆ†è¾¨ç‡æƒé‡ï¼š
- 720P: 1.0ï¼ˆä¸é™é€Ÿï¼‰
- 1080P: 0.65ï¼ˆé™é€Ÿ35%ï¼Œå› ä¸ºç”Ÿæˆæ…¢ï¼‰

æ—¶é•¿æƒé‡ï¼š
- 10ç§’: 1.3ï¼ˆå¿«30%ï¼‰
- 15ç§’: 1.0ï¼ˆåŸºå‡†ï¼‰
```

### å®é™…å¹¶å‘ç¤ºä¾‹

| åœºæ™¯ | Proå¥—é¤ | Pro+å¥—é¤ |
|------|---------|----------|
| Sora 2 720P 10s | 4-5ä¸ª | 7-9ä¸ª |
| Sora 2 720P 15s | 4ä¸ª | 7ä¸ª |
| Sora 2 Pro 1080P 10s | 2-3ä¸ª | 4-5ä¸ª |
| Sora 2 Pro 1080P 15s | 2ä¸ª | 3ä¸ª |

### ä¼˜å…ˆé˜Ÿåˆ—è°ƒåº¦

```
é˜¶æ®µ1ï¼šå¿«é€Ÿé˜Ÿåˆ—ï¼ˆ720P ä¼˜å…ˆï¼‰
  - Sora 2 720P 10s
  - Sora 2 720P 15s
  - Sora 2 Pro 720P
  - Sora 2 Pro 1080P 10s

é˜¶æ®µ2ï¼šæ…¢é€Ÿé˜Ÿåˆ—
  - Sora 2 Pro 1080P 15s
```

**ä¼˜åŠ¿**ï¼šç”¨æˆ·åœ¨ 10-20 åˆ†é’Ÿå†…å°±èƒ½çœ‹åˆ°å¤§éƒ¨åˆ† 720P è§†é¢‘ï¼Œè€Œä¸æ˜¯ç­‰å¾…å…¨éƒ¨å®Œæˆã€‚

---

## ğŸ›¡ï¸ é”™è¯¯ Fallback æœºåˆ¶

### 1. è‡ªåŠ¨é‡è¯•

```typescript
æœ€å¤§é‡è¯•æ¬¡æ•°: 3æ¬¡
é‡è¯•é—´éš”: æŒ‡æ•°é€€é¿ï¼ˆ2ç§’ â†’ 4ç§’ â†’ 8ç§’ï¼‰
å¯é‡è¯•é”™è¯¯:
  - è¶…æ—¶é”™è¯¯ï¼ˆETIMEDOUT, timeoutï¼‰
  - ç½‘ç»œé”™è¯¯ï¼ˆECONNRESET, ENOTFOUNDï¼‰
  - API é™æµï¼ˆ429, Rate limitï¼‰
  - æœåŠ¡å™¨é”™è¯¯ï¼ˆ500, 502, 503, 504ï¼‰
```

### 2. å¹¶å‘é™çº§

```typescript
è§¦å‘æ¡ä»¶: å¤±è´¥ç‡ > 30% ä¸”å·²å¤„ç† >= 10ä¸ªä»»åŠ¡
é™çº§ç­–ç•¥: å¹¶å‘æ•° Ã— 0.6ï¼ˆé™ä½ 40%ï¼‰
æœ€å°å¹¶å‘: 1ä¸ª
```

**ç¤ºä¾‹**ï¼š
```
åˆå§‹å¹¶å‘: 5ä¸ª
å¤±è´¥ç‡è¾¾åˆ° 35% â†’ é™ä½åˆ° 3ä¸ª
å¤±è´¥ç‡ä»é«˜ â†’ é™ä½åˆ° 1ä¸ªï¼ˆä¿å®ˆæ¨¡å¼ï¼‰
```

### 3. æ™ºèƒ½è½®è¯¢é—´éš”

æ ¹æ®å·²ç­‰å¾…æ—¶é—´è‡ªåŠ¨è°ƒæ•´æŸ¥è¯¢é¢‘ç‡ï¼ŒèŠ‚çœ API è°ƒç”¨ï¼š

**720P è§†é¢‘**ï¼š
- 0-1.5åˆ†é’Ÿï¼šæ¯ 3ç§’ æŸ¥è¯¢
- 1.5-3åˆ†é’Ÿï¼šæ¯ 5ç§’ æŸ¥è¯¢
- 3åˆ†é’Ÿåï¼šæ¯ 8ç§’ æŸ¥è¯¢

**1080P è§†é¢‘**ï¼š
- 0-5åˆ†é’Ÿï¼šæ¯ 5ç§’ æŸ¥è¯¢
- 5-10åˆ†é’Ÿï¼šæ¯ 8ç§’ æŸ¥è¯¢
- 10åˆ†é’Ÿåï¼šæ¯ 12ç§’ æŸ¥è¯¢

---

## ğŸ“Š æ€§èƒ½é¢„ä¼°

### 100ä¸ªè§†é¢‘å¤„ç†æ—¶é—´

#### Pro å¥—é¤

| åœºæ™¯ | 720P | 1080P | æ··åˆï¼ˆ50:50ï¼‰ |
|------|------|-------|--------------|
| æ—¶é—´ | 42åˆ†é’Ÿ | 4.2å°æ—¶ | 2.5å°æ—¶ |
| å¿«é€Ÿéƒ¨åˆ†å¯ç”¨ | - | - | 22åˆ†é’Ÿï¼ˆ50ä¸ª720Pï¼‰ |

#### Pro+ å¥—é¤

| åœºæ™¯ | 720P | 1080P | æ··åˆï¼ˆ50:50ï¼‰ |
|------|------|-------|--------------|
| æ—¶é—´ | 25åˆ†é’Ÿ | 2.8å°æ—¶ | 1.7å°æ—¶ |
| å¿«é€Ÿéƒ¨åˆ†å¯ç”¨ | - | - | 12åˆ†é’Ÿï¼ˆ50ä¸ª720Pï¼‰ |

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### API è°ƒç”¨

```typescript
POST /api/v1/workflow/batch-generate

{
  "rows": [
    {
      "rowIndex": 0,
      "prompt": "A cat playing piano",
      "enhancedPrompt": "A fluffy orange cat...",
      "model": "sora-2-pro",
      "resolution": "1080p",
      "duration": 15
    },
    {
      "rowIndex": 1,
      "prompt": "A dog running",
      "enhancedPrompt": "A golden retriever...",
      "model": "sora-2",
      "resolution": "720p",
      "duration": 10
    }
  ],
  "generationType": "video",
  "mode": "t2v",
  "aspectRatio": "16:9",
  "defaultModel": "sora-2-pro",
  "defaultResolution": "720p",
  "defaultDuration": 15
}
```

### å“åº”

```json
{
  "success": true,
  "data": {
    "jobId": "uuid-here",
    "status": "processing",
    "totalRows": 2
  }
}
```

### æŸ¥è¯¢è¿›åº¦

```typescript
GET /api/v1/workflow/batch/{jobId}

å“åº”ï¼š
{
  "success": true,
  "data": {
    "jobId": "uuid",
    "status": "processing",
    "totalRows": 100,
    "processedRows": 45,
    "successfulRows": 43,
    "failedRows": 2
  }
}
```

---

## âš™ï¸ é…ç½®æ–‡ä»¶

### 1. ç§¯åˆ†é…ç½®

æ–‡ä»¶ï¼š`src/config/credits.config.ts`

```typescript
videoGeneration: {
  'sora-2-720p-10s': 15,
  'sora-2-720p-15s': 20,
  'sora-2-pro-720p-10s': 45,    // Sora 2 çš„ 3å€
  'sora-2-pro-720p-15s': 60,    // Sora 2 çš„ 3å€
  'sora-2-pro-1080p-10s': 100,  // 1080P é«˜åˆ†è¾¨ç‡
  'sora-2-pro-1080p-15s': 130,  // 1080P é«˜åˆ†è¾¨ç‡
}
```

### 2. æ‰¹é‡é…ç½®

æ–‡ä»¶ï¼š`src/config/batch.config.ts`

```typescript
export const BATCH_CONFIG = {
  pro: {
    userFacing: {
      concurrency: 3,
      batchSize: 15,
    },
    internal: {
      modelConcurrency: {
        'sora-2': 4,
        'sora-2-pro': 3,
      },
      resolutionWeight: {
        '720p': 1.0,
        '1080p': 0.65,
      },
      // ... æ›´å¤šé…ç½®
    }
  }
}
```

---

## ğŸ” ç›‘æ§ä¸æ—¥å¿—

### æ—¥å¿—ç¤ºä¾‹

```
[Job abc123] Starting priority queue processing: 100 tasks, plan=pro
[Job abc123] Task distribution: Fast=70, Slow=30
[Job abc123] Credit check passed: 2500/5000 credits
[Job abc123] âš¡ Phase 1: Processing fast tasks (720P)
[Job abc123] fast batch 1/5: 15 tasks
[Job abc123] Using concurrency=4
[Job abc123] Row 0, Attempt 1/3: sora-2-pro 720p 15s
[Job abc123] âœ… Row 0 completed: asset-id-here
[Job abc123] âš ï¸ High failure rate (35%), reducing concurrency: 4 â†’ 2
[Job abc123] âœ… Fast queue completed: 68/70 succeeded
[Job abc123] ğŸ¢ Phase 2: Processing slow tasks (1080P)
[Job abc123] slow batch 1/2: 15 tasks
[Job abc123] Using concurrency=2
[Job abc123] ğŸ‰ All tasks completed! Success: 96/100, Failed: 4
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç§¯åˆ†æ£€æŸ¥**ï¼šæ‰¹é‡å¤„ç†å‰ä¼šæ£€æŸ¥æ€»ç§¯åˆ†æ˜¯å¦å……è¶³
2. **å¤±è´¥å¤„ç†**ï¼šå¤±è´¥çš„ä»»åŠ¡ä¼šä¿å­˜åˆ°æ•°æ®åº“å¹¶æ ‡è®°çŠ¶æ€
3. **ä¸­æ–­æ¢å¤**ï¼šæš‚ä¸æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œä»»åŠ¡å¤±è´¥éœ€é‡æ–°æäº¤
4. **å¹¶å‘é™åˆ¶**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨æ§åˆ¶å¹¶å‘é¿å… API é™æµ
5. **è¶…æ—¶ä¿æŠ¤**ï¼š720P è¶…æ—¶ 5åˆ†é’Ÿï¼Œ1080P è¶…æ—¶ 15åˆ†é’Ÿ

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. åˆç†é€‰æ‹©åˆ†è¾¨ç‡

- é¢„è§ˆ/è‰ç¨¿ï¼šä½¿ç”¨ 720Pï¼ˆå¿«é€Ÿã€çœç§¯åˆ†ï¼‰
- æœ€ç»ˆäº¤ä»˜ï¼šä½¿ç”¨ 1080Pï¼ˆé«˜è´¨é‡ï¼‰

### 2. æ‰¹é‡å¤§å°å»ºè®®

- Pro ç”¨æˆ·ï¼šå•æ‰¹ < 50ä¸ªä»»åŠ¡
- Pro+ ç”¨æˆ·ï¼šå•æ‰¹ < 100ä¸ªä»»åŠ¡
- é¿å…å•æ‰¹è¶…è¿‡ 200ä¸ªï¼ˆå¤„ç†æ—¶é—´è¿‡é•¿ï¼‰

### 3. æ··åˆç­–ç•¥

å¯¹äº 100+ ä»»åŠ¡ï¼Œå»ºè®®åˆ†æ‰¹æäº¤ï¼š
- ç¬¬1æ‰¹ï¼š20ä¸ª 720Pï¼ˆå¿«é€ŸéªŒè¯ï¼‰
- ç¬¬2æ‰¹ï¼šå‰©ä½™ 1080Pï¼ˆæ­£å¼ç”Ÿäº§ï¼‰

### 4. é”™è¯¯å¤„ç†

- å¤±è´¥ç‡ > 30%ï¼šæ£€æŸ¥æç¤ºè¯è´¨é‡
- è¶…æ—¶é¢‘ç¹ï¼šè€ƒè™‘é™ä½å¹¶å‘æˆ–åˆ†æ‰¹
- ç§¯åˆ†ä¸è¶³ï¼šåŠæ—¶å……å€¼é¿å…ä¸­æ–­

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- é…ç½®ï¼š`src/config/batch.config.ts`
- å¤„ç†å™¨ï¼š`src/lib/batch/priority-queue-processor.ts`
- APIè·¯ç”±ï¼š`src/app/api/v1/workflow/batch-generate/route.ts`
- ç§¯åˆ†é…ç½®ï¼š`src/config/credits.config.ts`

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚

