<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Viecom Admin Diagnostic Tool</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 900px;
      margin: 30px auto;
      padding: 20px;
      background: #f8fafc;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 { color: #1e293b; margin-bottom: 10px; }
    .subtitle { color: #64748b; margin-bottom: 30px; }
    button {
      background: #8b5cf6;
      color: white;
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 5px;
      transition: all 0.2s;
    }
    button:hover { background: #7c3aed; transform: translateY(-1px); }
    button:disabled { background: #cbd5e1; cursor: not-allowed; }
    .result {
      margin-top: 20px;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 500px;
      overflow-y: auto;
    }
    .success { background: #d1fae5; border: 2px solid #10b981; color: #065f46; }
    .error { background: #fee2e2; border: 2px solid #ef4444; color: #991b1b; }
    .info { background: #dbeafe; border: 2px solid #3b82f6; color: #1e40af; }
    .warning { background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; }
    .step { margin: 15px 0; padding: 15px; background: #f1f5f9; border-radius: 6px; }
    .step-title { font-weight: 600; color: #334155; margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ Viecom Admin è¯Šæ–­å·¥å…·</h1>
    <p class="subtitle">è¯Šæ–­ç®¡ç†å‘˜ç™»å½•å’Œ Dashboard æŒ‚èµ·é—®é¢˜</p>
    
    <button onclick="runFullDiagnostic()">ğŸš€ è¿è¡Œå®Œæ•´è¯Šæ–­</button>
    <button onclick="testLogin()">ğŸ” æµ‹è¯•ç™»å½•</button>
    <button onclick="testDashboardAPI()">ğŸ“Š æµ‹è¯• Dashboard API</button>
    <button onclick="checkCookies()">ğŸª æ£€æŸ¥ Cookies</button>

    <div id="result"></div>
  </div>

  <script>
    const API_BASE = 'https://www.viecom.pro';
    const resultDiv = document.getElementById('result');

    function log(html, type = 'info') {
      resultDiv.className = `result ${type}`;
      resultDiv.innerHTML = html;
    }

    async function runFullDiagnostic() {
      log('ğŸ” å¼€å§‹å®Œæ•´è¯Šæ–­...\n', 'info');
      
      let report = '<div class="step"><div class="step-title">ğŸ“ è¯Šæ–­æŠ¥å‘Š</div>\n';
      report += `<strong>æ—¶é—´ï¼š</strong> ${new Date().toLocaleString()}\n\n`;

      // Test 1: Check API availability
      report += '<strong>æ­¥éª¤ 1ï¼šæ£€æŸ¥ API å¯ç”¨æ€§</strong>\n';
      try {
        const response = await fetch(`${API_BASE}/api/admin/auth/login`, {
          method: 'OPTIONS'
        });
        report += `âœ… API ç«¯ç‚¹å¯è®¿é—®\n`;
      } catch (error) {
        report += `âŒ API ç«¯ç‚¹ä¸å¯è®¿é—®: ${error.message}\n`;
      }
      report += '\n';

      // Test 2: Test login
      report += '<strong>æ­¥éª¤ 2ï¼šæµ‹è¯•ç™»å½•</strong>\n';
      try {
        const loginResponse = await fetch(`${API_BASE}/api/admin/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'admin@viecom.pro',
            password: 'admin123456',
            remember: false
          }),
          credentials: 'include'
        });

        const loginData = await loginResponse.json();
        
        if (loginResponse.ok) {
          report += `âœ… ç™»å½•æˆåŠŸ (${loginResponse.status})\n`;
          report += `   ç®¡ç†å‘˜: ${loginData.admin?.email}\n`;
          report += `   ID: ${loginData.admin?.id}\n`;
        } else {
          report += `âŒ ç™»å½•å¤±è´¥ (${loginResponse.status})\n`;
          report += `   é”™è¯¯: ${loginData.error}\n`;
          
          if (loginResponse.status === 401) {
            report += `   ğŸ’¡ åŸå› ï¼šè´¦å·ä¸å­˜åœ¨æˆ–å¯†ç é”™è¯¯\n`;
            report += `   ğŸ“ è§£å†³ï¼šè¿è¡Œ node create-admin-direct.cjs\n`;
          } else if (loginResponse.status === 500) {
            report += `   ğŸ’¡ åŸå› ï¼šæœåŠ¡å™¨é”™è¯¯\n`;
            report += `   ğŸ“ å¯èƒ½ï¼šDATABASE_URL æˆ– ADMIN_JWT_SECRET æœªè®¾ç½®\n`;
          }
        }
      } catch (error) {
        report += `âŒ ç™»å½•è¯·æ±‚å¤±è´¥: ${error.message}\n`;
      }
      report += '\n';

      // Test 3: Check cookies
      report += '<strong>æ­¥éª¤ 3ï¼šæ£€æŸ¥ Cookies</strong>\n';
      const cookies = document.cookie.split(';').map(c => c.trim());
      const adminCookie = cookies.find(c => c.startsWith('admin_token='));
      
      if (adminCookie) {
        report += `âœ… admin_token cookie å·²è®¾ç½®\n`;
        report += `   å€¼: ${adminCookie.substring(0, 40)}...\n`;
      } else {
        report += `âŒ admin_token cookie æœªè®¾ç½®\n`;
        report += `   ğŸ’¡ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ— æ³•è®¿é—® Dashboardï¼\n`;
        report += `   ğŸ“ å¯èƒ½åŸå› ï¼š\n`;
        report += `      1. ç™»å½•å¤±è´¥\n`;
        report += `      2. Cookie è®¾ç½®è¢«é˜»æ­¢ï¼ˆæµè§ˆå™¨ç­–ç•¥ï¼‰\n`;
        report += `      3. ADMIN_JWT_SECRET æœªåœ¨ Vercel è®¾ç½®\n`;
      }
      report += '\n';

      // Test 4: Test Dashboard API
      report += '<strong>æ­¥éª¤ 4ï¼šæµ‹è¯• Dashboard API</strong>\n';
      try {
        const dashResponse = await fetch(`${API_BASE}/api/admin/dashboard/stats?range=7d`, {
          credentials: 'include'
        });

        if (dashResponse.status === 401) {
          report += `âŒ Dashboard API è¿”å› 401 (æœªæˆæƒ)\n`;
          report += `   ğŸ’¡ Cookie æ— æ•ˆæˆ–æœªè®¾ç½®\n`;
          report += `   ğŸ“ éœ€è¦å…ˆæˆåŠŸç™»å½•\n`;
        } else if (dashResponse.status === 500) {
          report += `âŒ Dashboard API è¿”å› 500 (æœåŠ¡å™¨é”™è¯¯)\n`;
          report += `   ğŸ’¡ å¯èƒ½æ•°æ®åº“æŸ¥è¯¢å¤±è´¥\n`;
          report += `   ğŸ“ æ£€æŸ¥ Vercel Function Logs\n`;
        } else if (dashResponse.ok) {
          report += `âœ… Dashboard API æ­£å¸¸ (${dashResponse.status})\n`;
          const dashData = await dashResponse.json();
          report += `   æ•°æ®åŠ è½½æˆåŠŸ\n`;
        } else {
          report += `âš ï¸  Dashboard API è¿”å› ${dashResponse.status}\n`;
        }
      } catch (error) {
        report += `âŒ Dashboard API è¯·æ±‚å¤±è´¥: ${error.message}\n`;
      }
      report += '\n';

      report += '</div>\n\n';

      // Conclusion
      report += '<div class="step"><div class="step-title">ğŸ¯ è¯Šæ–­ç»“è®º</div>\n';
      
      if (adminCookie) {
        report += '<strong>âœ… ç™»å½•æ­£å¸¸ï¼Œå¯ä»¥è®¿é—® Dashboard</strong>\n\n';
        report += 'ğŸ“ ä¸‹ä¸€æ­¥ï¼š\n';
        report += '1. è®¿é—®ï¼šhttps://www.viecom.pro/admin/dashboard\n';
        report += '2. å¦‚æœä»ç„¶æŒ‚èµ·ï¼Œæ£€æŸ¥æµè§ˆå™¨ Console çš„é”™è¯¯ä¿¡æ¯\n';
      } else {
        report += '<strong>âŒ ç™»å½•å­˜åœ¨é—®é¢˜ï¼Œæ— æ³•è®¿é—® Dashboard</strong>\n\n';
        report += 'ğŸ“ è§£å†³æ­¥éª¤ï¼š\n';
        report += '1. æ£€æŸ¥ Vercel ç¯å¢ƒå˜é‡æ˜¯å¦è®¾ç½® ADMIN_JWT_SECRET\n';
        report += '2. ç¡®è®¤æ•°æ®åº“ä¸­å­˜åœ¨ admin è´¦å·\n';
        report += '3. é‡æ–°éƒ¨ç½² Vercel åº”ç”¨\n';
        report += '4. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œ Cookie\n';
        report += '5. é‡æ–°å°è¯•ç™»å½•\n';
      }
      
      report += '</div>';

      log(report, adminCookie ? 'success' : 'warning');
    }

    async function testLogin() {
      log('ğŸ” æµ‹è¯•ç™»å½•...\n', 'info');
      
      try {
        const response = await fetch(`${API_BASE}/api/admin/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'admin@viecom.pro',
            password: 'admin123456',
            remember: false
          }),
          credentials: 'include'
        });

        const data = await response.json();
        
        let result = `ğŸ“Š çŠ¶æ€ç : ${response.status}\n\n`;
        result += `ğŸ“¦ å“åº”æ•°æ®:\n${JSON.stringify(data, null, 2)}\n\n`;

        if (response.ok) {
          result += 'âœ… ç™»å½•æˆåŠŸï¼\n';
          result += '\nğŸª æ­£åœ¨æ£€æŸ¥ cookie...\n';
          setTimeout(() => {
            const cookies = document.cookie.split(';').map(c => c.trim());
            const adminCookie = cookies.find(c => c.startsWith('admin_token='));
            if (adminCookie) {
              log(result + '\nâœ… Cookie å·²è®¾ç½®ï¼å¯ä»¥è®¿é—® Dashboard äº†ã€‚', 'success');
            } else {
              log(result + '\nâŒ Cookie æœªè®¾ç½®ï¼è¿™æ˜¯é—®é¢˜æ‰€åœ¨ã€‚', 'error');
            }
          }, 500);
        } else {
          result += 'âŒ ç™»å½•å¤±è´¥ï¼\n';
          result += `é”™è¯¯: ${data.error}\n`;
          log(result, 'error');
        }
      } catch (error) {
        log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testDashboardAPI() {
      log('ğŸ“Š æµ‹è¯• Dashboard API...\n', 'info');
      
      try {
        const response = await fetch(`${API_BASE}/api/admin/dashboard/stats?range=7d`, {
          credentials: 'include'
        });

        let result = `ğŸ“Š çŠ¶æ€ç : ${response.status}\n\n`;

        if (response.ok) {
          const data = await response.json();
          result += 'âœ… API æ­£å¸¸ï¼\n\n';
          result += `ğŸ“¦ æ•°æ®:\n${JSON.stringify(data, null, 2)}`;
          log(result, 'success');
        } else {
          const data = await response.json();
          result += 'âŒ API å¤±è´¥ï¼\n\n';
          result += `é”™è¯¯: ${JSON.stringify(data, null, 2)}\n\n`;
          
          if (response.status === 401) {
            result += 'ğŸ’¡ åŸå› ï¼šæœªæˆæƒï¼Œéœ€è¦å…ˆç™»å½•';
          } else if (response.status === 500) {
            result += 'ğŸ’¡ åŸå› ï¼šæœåŠ¡å™¨é”™è¯¯ï¼Œæ£€æŸ¥ Vercel Logs';
          }
          
          log(result, 'error');
        }
      } catch (error) {
        log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      }
    }

    function checkCookies() {
      const cookies = document.cookie.split(';').map(c => c.trim());
      
      let result = 'ğŸª å½“å‰ Cookies:\n\n';
      
      if (cookies.length === 0 || (cookies.length === 1 && cookies[0] === '')) {
        result += 'âŒ æ²¡æœ‰ä»»ä½• cookies\n';
        log(result, 'warning');
        return;
      }

      const adminCookie = cookies.find(c => c.startsWith('admin_token='));
      
      if (adminCookie) {
        result += `âœ… admin_token: ${adminCookie.substring(0, 50)}...\n\n`;
        result += 'âœ¨ Cookie å·²è®¾ç½®ï¼Œå¯ä»¥è®¿é—® Dashboardï¼';
        log(result, 'success');
      } else {
        result += `ğŸ“‹ æ‰€æœ‰ Cookies (${cookies.length}):\n`;
        cookies.forEach(c => {
          result += `   - ${c.substring(0, 60)}...\n`;
        });
        result += '\nâŒ æ²¡æœ‰æ‰¾åˆ° admin_token\n';
        result += '\nğŸ’¡ éœ€è¦å…ˆç™»å½•æ‰èƒ½è®¿é—® Dashboard';
        log(result, 'warning');
      }
    }
  </script>
</body>
</html>

