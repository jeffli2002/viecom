# 订阅变更积分调整规则表

## 积分配置参考

| 计划 | 月付积分 | 年付积分 |
|------|---------|---------|
| Free | 0 | 0 |
| Pro | 500 | 6,000 (500 × 12) |
| Pro+ | 900 | 10,800 (900 × 12) |

---

## 订阅变更场景积分调整表

| 变更场景 | 旧计划积分 | 新计划积分 | 积分变化 | 生效时间 | 说明 |
|---------|----------|----------|---------|---------|------|
| **新订阅创建** |
| Free → Pro (月付) | 0 | 500 | +500 | 立即生效 | 授予完整积分 |
| Free → Pro (年付) | 0 | 6,000 | +6,000 | 立即生效 | 授予完整积分 |
| Free → Pro+ (月付) | 0 | 900 | +900 | 立即生效 | 授予完整积分 |
| Free → Pro+ (年付) | 0 | 10,800 | +10,800 | 立即生效 | 授予完整积分 |
| **计划升级（同周期）** |
| Pro (月付) → Pro+ (月付) | 500 | 900 | +400 | 立即生效 | 调整积分差异 |
| Pro (年付) → Pro+ (年付) | 6,000 | 10,800 | +4,800 | 立即生效 | 调整积分差异 |
| **计划降级（同周期）** |
| Pro+ (月付) → Pro (月付) | 900 | 500 | +500 | 周期结束时生效 | 旧计划结束后，授予新计划完整积分 |
| Pro+ (年付) → Pro (年付) | 10,800 | 6,000 | +6,000 | 周期结束时生效 | 旧计划结束后，授予新计划完整积分 |
| **周期升级（同计划）** |
| Pro (月付) → Pro (年付) | 500 | 6,000 | +5,500 | 立即生效 | 调整积分差异 |
| Pro+ (月付) → Pro+ (年付) | 900 | 10,800 | +9,900 | 立即生效 | 调整积分差异 |
| **周期降级（同计划）** |
| Pro (年付) → Pro (月付) | 6,000 | 500 | +500 | 周期结束时生效 | 旧计划结束后，授予新计划完整积分 |
| Pro+ (年付) → Pro+ (月付) | 10,800 | 900 | +900 | 周期结束时生效 | 旧计划结束后，授予新计划完整积分 |
| **计划与周期同时变更** |
| Pro (月付) → Pro+ (年付) | 500 | 10,800 | +10,300 | 立即生效 | 调整积分差异 |
| Pro (月付) → Pro+ (月付) | 500 | 900 | +400 | 立即生效 | 调整积分差异 |
| Pro (年付) → Pro+ (月付) | 6,000 | 900 | +900 | 周期结束时生效 | 旧计划结束后，授予新计划完整积分 |
| Pro (年付) → Pro+ (年付) | 6,000 | 10,800 | +4,800 | 立即生效 | 调整积分差异 |
| Pro+ (月付) → Pro (年付) | 900 | 6,000 | +6,000 | 立即生效 | 调整积分差异 |
| Pro+ (月付) → Pro (月付) | 900 | 500 | +500 | 周期结束时生效 | 旧计划结束后，授予新计划完整积分 |
| Pro+ (年付) → Pro (月付) | 10,800 | 500 | +500 | 周期结束时生效 | 旧计划结束后，授予新计划完整积分 |
| Pro+ (年付) → Pro (年付) | 10,800 | 6,000 | +6,000 | 周期结束时生效 | 旧计划结束后，授予新计划完整积分 |

---

## 特殊场景说明

### 1. 试用期订阅
- **状态**: `trialing` → `active`
- **积分授予**: 试用期结束时立即授予完整积分
- **生效时间**: 试用期结束，状态变为 `active` 时

### 2. 订阅续费
- **触发条件**: 检测到 `periodEnd` 更新且时间增加超过 1 分钟
- **积分授予**: 授予完整月度/年度积分
- **生效时间**: 续费周期开始时
- **标记**: `isRenewal = true`

### 3. 订阅降级（新积分 < 旧积分）
- **生效时间**: 当前周期结束时（periodEnd）
- **积分处理**: 在周期结束时授予新计划的完整积分（相当于开始新订阅）
- **访问权限**: 周期结束前仍可使用旧计划的积分和功能
- **标记**: `cancelAtPeriodEnd = true` 表示降级已安排
- **示例**: Pro+ (年付) → Pro (月付)
  - Pro+ 年付周期结束后
  - 开始新的 Pro 月付计划
  - 授予 Pro 月付的完整积分（500），而不是扣除积分差异

### 4. 订阅取消（cancelAtPeriodEnd = true）
- **积分处理**: 不立即扣除积分
- **访问权限**: 周期结束前仍可使用服务
- **积分状态**: 保持当前积分余额

### 5. 订阅立即取消
- **状态**: `active` → `canceled`
- **积分处理**: 不扣除已授予的积分
- **访问权限**: 立即停止

---

## 积分调整逻辑

### 新订阅创建
```typescript
// 授予完整积分
grantSubscriptionCredits(userId, planId, subscriptionId, interval)
```

### 计划/周期变更

#### 升级场景（新积分 > 旧积分）
```typescript
// 立即调整积分差异
creditDifference = newCredits - oldCredits
// creditDifference > 0: 立即增加积分
adjustCreditsForPlanChange(userId, oldPlanId, newPlanId, subscriptionId, oldInterval, newInterval)
```

#### 降级场景（新积分 < 旧积分）
```typescript
// 安排在周期结束时生效
// 1. 设置 cancelAtPeriodEnd = true
// 2. 在续费检测时（periodEnd 更新时）授予新计划的完整积分
// 相当于旧计划结束后，开始一个新的订阅计划
// 例如：Pro+ (年付) 结束后，开始 Pro (月付)，授予 Pro 月付的完整积分（500）
```

### 生效时间规则

| 场景 | 生效时间 | 说明 |
|------|---------|------|
| 新订阅创建 | 立即生效 | 授予完整积分 |
| Free → Paid | 立即生效 | 授予完整积分 |
| 升级（积分增加） | 立即生效 | 立即增加积分差异 |
| 降级（积分减少） | 周期结束时生效 | 旧计划结束后，授予新计划的完整积分（相当于新订阅） |
| 订阅续费 | 续费周期开始时 | 授予完整积分（或处理降级） |

### 积分差异计算
- **旧计划积分**: `getCreditsForPlan(oldPlanId, oldInterval).amount`
- **新计划积分**: `getCreditsForPlan(newPlanId, newInterval).amount`
- **积分变化**: `newCredits - oldCredits`

---

## 注意事项

1. **积分不会为负**: 如果扣除后余额为负，余额会被设置为 0
2. **立即生效**: 所有积分变更都在订阅更新时立即生效
3. **交易记录**: 所有积分变更都会记录在 `creditTransactions` 表中
4. **幂等性**: 使用 `referenceId` 确保不会重复授予积分

---

## 测试场景检查清单

- [ ] Free → Pro monthly: 应授予 500 积分
- [ ] Free → Pro yearly: 应授予 6,000 积分
- [ ] Pro monthly → Pro yearly: 应增加 5,500 积分
- [ ] Pro monthly → Pro+ monthly: 应增加 400 积分
- [ ] Pro monthly → Pro+ yearly: 应增加 10,300 积分
- [ ] Pro+ monthly → Pro monthly: 应扣除 400 积分
- [ ] Pro yearly → Pro monthly: 应扣除 5,500 积分
- [ ] 订阅续费: 应授予完整积分
- [ ] 试用期结束: 应授予完整积分

